<!DOCTYPE html>
<html lang="cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>一些知识</title>
    <!-- 引入 Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="/assets/css/Comm/CommStyle.css">
</head>
<body>
    <div id="sidebar">
        <!-- 个人信息部分 -->
        <div id="personal-info">
            <h3>一个路过的假人</h3>
            <p style="font-size: 12px;color: lightgray;">一个掌握了各种技能的嵌入式软件工程师</p>
            <p>总感觉你们在背着我学习</p>
        </div>
        <hr>
        <!-- 描述 -->
        <div margin="10px">
            <table>
                <tr>
                    <td>经验值: </td>
                    <td>10</td>
                </tr>
                <tr>
                    <td>状态: </td>
                    <td> 存在</td>
                </tr>
            </table>
        </div>
        <hr>
        <!-- 链接 -->
        <div id="link-info" >
            <a href="/index.html" class="link-light" >HOME</a>
            <a href="/about.html" class="link-light" >ABOUT</a>
        </div>
    </div>
    <div id="bar-setting">
    <div id="bar-content">
        <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
            <ol class="breadcrumb">
            <li class="breadcrumb-item"><a class="link-info" href="/index.html">Home</a></li>
            
            <li class="breadcrumb-item"><a class="link-info" href="/classes/others.html">万象</a></li>
            <li class="breadcrumb-item active" aria-current="page">lua脚本在单片机中使用</li>
            </ol>
        </nav>
    </div>
</div>

<div id="content">
    <div id="post-setting">
        <h1>lua脚本在单片机中使用</h1>
        <div id="post-time">2022-11-11</div>
        <hr>
    
        <p>简单介绍了如何将lua解释器移植到单片机中，和如何在单片机中使用。</p>

<h2 id="一将lua解释器移植到单片机">一，将lua解释器移植到单片机</h2>

<ol>
  <li>[必须] 删除src文件夹种的lua.c和luac.c文件</li>
  <li>[可选] lauxlib.c - 把l_alloc函数调用的free和realloc替换为自定义的内存管理函数。或增大heap size。</li>
  <li>[可选] init.c - 通过loadedlibs删除不需要的功能/注释,如luaopen_os,luaopen_io,luaopen_debug。可添加自己的功能库。</li>
  <li>[必须] luaconf.h 使能#define LUA_32BITS。</li>
  <li>[必须] 修改堆栈大小，stack size设为4Ki。</li>
  <li>[必须] 添加头文件 “lua.h”,”lualib.h”和”lauxlib.h”</li>
  <li>[必须] 实现函数time()。</li>
</ol>

<hr />

<h2 id="二简单使用">二，简单使用</h2>

<ul>
  <li>运行lua</li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">char</span> <span class="n">buf</span><span class="p">[]</span> <span class="o">=</span> <span class="s">""</span><span class="p">;</span>
<span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="c1">//建立lua运行环境</span>
<span class="n">L</span> <span class="o">=</span> <span class="n">luaL_newstate</span><span class="p">();</span>
<span class="k">if</span><span class="p">(</span><span class="n">L</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//注册各种库函数</span>
    <span class="n">luaL_openlibs</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
    <span class="c1">//运行基础库</span>
    <span class="n">luaopen_base</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
    <span class="c1">//运行lua脚本</span>
    <span class="n">luaL_dostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
    <span class="c1">//关闭lua</span>
    <span class="n">lua_close</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<ul>
  <li>接口函数形式</li>
</ul>

<pre><code class="language-C">static int func1(lua_State *L)
{
    //返回结果数量
    return 1;
}
</code></pre>

<ul>
  <li>注册接口函数方式1</li>
</ul>

<pre><code class="language-C">lua_register(L,"name",func1);
</code></pre>

<ul>
  <li>注册接口函数方式2</li>
</ul>

<pre><code class="language-C">static const luaL_Reg mylib[]={
    {"name",func1},
    {NULL,NULL}
};
//添加open函数
LUALIB_API int luaopen_mylib(lua_State *L)
{
    luaL_newlib(L,mylib);
    return 1;
}
//注册函数
lua_requiref(L,"mylib",luaopen_mylib,1);
lua_pop(L,1);
</code></pre>

<hr />

<h2 id="三lua-c语言-api">三，lua C语言 API</h2>

<ul>
  <li>判断类</li>
</ul>

<pre><code class="language-C">//函数
lua_isfunction(L,n);
//表类型
lua_istable(L,n);
//轻用户数据
lua_islightuserdata(L,n);
//零
lua_isnil(L,n);
//布尔型
lua_isboolean(L,n);
//线程
lua_isthread(L,n);
//空
lua_isnone(L,n);
//零或空
lua_isnoneornil(L,n);
//整形
lua_isinteger(L,n);
//浮点型
lua_isnumber(L,n);
//字符串
lua_isstring(L,n);
//用户数据
lua_isuserdata(L,n);
</code></pre>

<ul>
  <li>压入返回结果</li>
</ul>

<pre><code class="language-C">//压入零
lua_pushnil(L);
//浮点数
lua_pushnumber(L,n);
//整型
lua_pushinteger(L,n);
//字符串
lua_pushlstring(L,s,len);
//字符串
lua_pushstring(L,s);
//字符串
lua_pushvfstring(L,fmt,ragp);
//字符串
lua_pushfstring(L,fmt,...);
//c函数闭包
lua_pushcclosure(L,fn,n);
//布尔
lua_pushboolean(L,n);
//轻用户数据
lua_pushlightuserdata(L,n);
//线程
lua_pushthread(L);
</code></pre>

    </div>
</div>
</body>
</html>