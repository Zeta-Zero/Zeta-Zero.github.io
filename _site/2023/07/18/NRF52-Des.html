<!DOCTYPE html>
<html lang="cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>一些知识</title>
    <!-- 引入 Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="/assets/css/Comm/CommStyle.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">
</head>
<body>
    <div id="sidebar">
        <!-- 个人信息部分 -->
        <div id="personal-info">
            <h3>一个路过的假人</h3>
            <p style="font-size: 12px;color: lightgray;">一个掌握了各种技能的嵌入式软件工程师</p>
            <p>总感觉你们在背着我学习</p>
        </div>
        <hr>
        <!-- 描述 -->
        <div margin="10px">
            <table>
                <tr>
                    <td>经验值: </td>
                    <td>10</td>
                </tr>
                <tr>
                    <td>状态: </td>
                    <td> 存在</td>
                </tr>
            </table>
        </div>
        <hr>
        <!-- 链接 -->
        <div id="link-info" >
            <a href="/index.html" class="link-light" >HOME</a>
            <a href="/about.html" class="link-light" >ABOUT</a>
        </div>
    </div>
    <div id="bar-setting">
    <div id="bar-content">
        <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
            <ol class="breadcrumb">
            <li class="breadcrumb-item"><a class="link-info" href="/index.html">Home</a></li>
            
            <li class="breadcrumb-item"><a class="link-info" href="/classes/piecemeal_techs.html">零碎的技术合集</a></li>
            <li class="breadcrumb-item active" aria-current="page">NRF52 资料</li>
            </ol>
        </nav>
    </div>
</div>

<div id="content">
    <div id="post-setting">
        <h1>NRF52 资料</h1>
        <div id="post-time">2023-07-18</div>
        <hr>
    
        <p>记录了与NRF52相关的资料</p>

<h2 id="存储空间布局">存储空间布局</h2>

<table>
  <thead>
    <tr>
      <th>组件</th>
      <th>存储空间范围 S132</th>
      <th>存储空间范围 S140</th>
      <th>存储空间范围 S112</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Bootloader settings</td>
      <td>0x0007 F000~0x0008 0000(4KiB)</td>
      <td>0x000F F000~0x0010 0000(4KiB)</td>
      <td>0x0002 F000~0x0003 0000(4KiB)</td>
    </tr>
    <tr>
      <td>MBR parameter storage</td>
      <td>0x0007 E000~0x0007 F000(4Kib)</td>
      <td>0x000F E000~0x000F F000(4Kib)</td>
      <td>0x0002 E000~0x0002 F000(4KiB)</td>
    </tr>
    <tr>
      <td>Bootloader</td>
      <td>0x0007 8000~0x0007 E000(24KiB)</td>
      <td>0x000F 8000~0x000F E000(24KiB)</td>
      <td>0x0002 8000~0x0002 E000 (24KiB)</td>
    </tr>
    <tr>
      <td>Application area</td>
      <td>0x0002 6000~0x0007 8000(328KiB)</td>
      <td>0x0002 6000~0x000F 8000(840KiB)</td>
      <td>0x0001 9000~0x0002 8000(60KiB)</td>
    </tr>
    <tr>
      <td>SoftDevice</td>
      <td>0x0000 1000~0x0002 6000(148KiB)</td>
      <td>0x0000 1000 - 0x0002 6000(148KiB)</td>
      <td>0x0000 1000 - 0x0001 9000(96KiB)</td>
    </tr>
    <tr>
      <td>Master Boot Record(MBR)</td>
      <td>0x0000 0000~0x0000 1000(4KiB)</td>
      <td>0x0000 0000~0x0000 1000(4KiB)</td>
      <td>0x0000 0000~0x0000 1000(4KiB)</td>
    </tr>
  </tbody>
</table>

<p><br /></p>

<hr />

<h2 id="bootloader">Bootloader</h2>

<h3 id="参数">参数</h3>

<p>bootloader 开始地址存放到 UICR.BOOTLOADERADDR 中，UICR.BOOTLOADERADDR 被映射在 0x10001014 (NRF_UICR_BOOTLOADER_START_ADDRESS)</p>

<h3 id="跳转">跳转</h3>

<p>bootloader 跳转到 APP 前的处理：<br />
在含有协议库的情况下</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="code"><pre><span class="n">sd_mbr_command_t</span> <span class="n">command</span> <span class="o">=</span>
<span class="p">{</span>
    <span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">SD_MBR_COMMAND_IRQ_FORWARD_ADDRESS_SET</span><span class="p">,</span>
    <span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">irq_forward_address_set</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">ret_val</span> <span class="o">=</span> <span class="n">sd_mbr_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">command</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="n">NRF_ERROR_INVALID_PARAM</span> <span class="o">==</span> <span class="n">ret_val</span><span class="p">){</span>
    <span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)(</span><span class="mh">0x20000000</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">......</span>
<span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">jmp_addr</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">_addr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)));</span>  <span class="c1">//_addr 为APP所在地址</span>
<span class="n">__disable_irq</span><span class="p">();</span>
<span class="k">for</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">NVIC</span><span class="o">-&gt;</span><span class="n">ICER</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mh">0xFFFFFFFF</span><span class="p">;</span>
    <span class="n">NVIC</span><span class="o">-&gt;</span><span class="n">ICPR</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mh">0xFFFFFFFF</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__set_CONTROL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>   <span class="c1">// Set CONTROL to its reset value 0.</span>
<span class="n">__set_PRIMASK</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>   <span class="c1">// Set PRIMASK to its reset value 0.</span>
<span class="n">__set_BASEPRI</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>   <span class="c1">// Set BASEPRI to its reset value 0.</span>
<span class="n">__set_FAULTMASK</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// Set FAULTMASK to its reset value 0.</span>
<span class="n">__enable_irq</span><span class="p">();</span>
<span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span><span class="n">jmp_addr</span><span class="p">)();</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>需要注意的是：<br />
1.中断向表是在0x00000000的位置，并不是在APP所在地址的位置。<br />
2.使用__set_MSP，会使程序跑飞。<br />
3.当 SD_EVT_IRQHandler 无响应时，需要包含头文件“nrf_soc.h”，或使用 SWI2_EGU2_IRQHandler。</p>

<p><br /></p>

<hr />

<h2 id="dfu-参数">DFU 参数</h2>

<p>关于结构体nrf_dfu_settings_t的内部成员描述。</p>

<table>
  <thead>
    <tr>
      <th>类型</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>crc</td>
      <td>存储的DFU设置的CRC，不包括CRC本身。如果0xFFFFFFF，表示CRC从未计算过。</td>
    </tr>
    <tr>
      <td>boot_validation_app.bytes</td>
      <td>存储新固件的CRC32数据</td>
    </tr>
    <tr>
      <td>progress.update_start_address</td>
      <td>bank1在flash的起始地址</td>
    </tr>
    <tr>
      <td>bank1.image_size</td>
      <td>新固件大小</td>
    </tr>
    <tr>
      <td>bank1.image_crc</td>
      <td>新固件的CRC校验值，可以用crc32_compute()计算</td>
    </tr>
    <tr>
      <td>bank1.bank_code</td>
      <td>设置为NRF_DFU_BANK_VALID_APP，使其为有效固件</td>
    </tr>
  </tbody>
</table>

<p><br /></p>

<hr />

<h2 id="协议栈版本">协议栈版本</h2>

<ul>
  <li>名称格式：S[xyz]
    <ul>
      <li>[ x ] 协议栈的类型，1为BLE协议栈，2为ANT协议栈，3为同时支持两者</li>
      <li>[ y ] BLE角色，1为从设备，2为主设备，3为同时支持两者</li>
      <li>[ z ] 芯片类型，0 为nRF51系列，2 为nRF52系列</li>
    </ul>
  </li>
</ul>

<p><br /></p>

<hr />

<h2 id="ble-提速">BLE 提速</h2>

<ul>
  <li>增大ATT_MTU为247</li>
  <li>启动CLE功能，配置在协议栈初始化后</li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="n">ret_code_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">NRF_SUCCESS</span><span class="p">;</span>
<span class="n">ble_opt_t</span> <span class="n">opt</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">common_opt</span><span class="p">.</span><span class="n">conn_evt_ext</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">ret_code</span> <span class="o">=</span> <span class="n">sd_ble_opt_set</span><span class="p">(</span><span class="n">BLE_COMMON_OPT_CONN_EVT_EXT</span><span class="p">,</span><span class="o">&amp;</span><span class="n">opt</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></figure>

<ul>
  <li>增加连接事件长度：BLE_CONN_CFG_GAP</li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="n">ble_cfg_t</span> <span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">conn_cfg</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">gap_conn_cfg</span><span class="p">.</span><span class="n">event_length</span> <span class="o">=</span> <span class="mi">400</span><span class="p">,</span> <span class="cm">/* 400*1.25ms */</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></pre></figure>

<ul>
  <li>使用BLE_GAP_PHY_2MBPS</li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="code"><pre><span class="n">ble_gap_phys_t</span> <span class="n">phy</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">tx_phys</span> <span class="o">=</span> <span class="n">BLE_GAP_PHY_2MBPS</span><span class="p">,</span>
    <span class="p">.</span><span class="n">rx_phys</span> <span class="o">=</span> <span class="n">BLE_GAP_PHY_2MBPS</span><span class="p">,</span>
<span class="p">};</span>
<span class="kt">void</span> <span class="nf">ble_evt_handler</span><span class="p">(</span><span class="n">ble_evt</span> <span class="k">const</span><span class="o">*</span> <span class="n">_event</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="n">_context</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">_event</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">evt_id</span><span class="p">){</span>
        <span class="k">case</span> <span class="n">BLE_GAP_EVT_CONNECTED</span><span class="p">:{</span>
            <span class="n">sd_ble_gap_phy_update</span><span class="p">(</span><span class="n">_event</span><span class="o">-&gt;</span><span class="n">evt</span><span class="p">.</span><span class="n">gap_evt</span><span class="p">.</span><span class="n">conn_handle</span><span class="p">,</span><span class="o">&amp;</span><span class="n">phy</span><span class="p">);</span>
        <span class="p">}</span><span class="k">break</span><span class="p">;</span>
        <span class="k">default</span> <span class="o">:</span><span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<ul>
  <li>调整连接间隔，其中BLE_CONN_CFG_GAP大于等于maxval。
    <ul>
      <li>50ms  - 1328kbps</li>
      <li>400ms - 1376kbps</li>
    </ul>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="n">ble_gap_conn_params_t</span> <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">min_conn_interval</span> <span class="o">=</span> <span class="n">minval</span><span class="p">,</span>  <span class="cm">/*最小连接间隔 单位：1.25ms*/</span>
    <span class="p">.</span><span class="n">max_conn_interval</span> <span class="o">=</span> <span class="n">maxval</span><span class="p">,</span>  <span class="cm">/*最大连接间隔 单位：1.25ms*/</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></pre></figure>

<ul>
  <li>增大协议栈发送Buff</li>
</ul>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="n">ret_code_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">NRF_SUCCESS</span><span class="p">;</span>
<span class="n">ble_cfg_t</span> <span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">conn_cfg</span><span class="p">.</span><span class="n">conn_cfg_tag</span> <span class="o">=</span> <span class="n">CFG_Tag</span><span class="p">,</span>
    <span class="p">.</span><span class="n">conn_cfg</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">gattc_conn_cfg</span><span class="p">.</span><span class="n">write_cmd_tx_queue_size</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="p">.</span><span class="n">conn_cfg</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">gatts_conn_cfg</span><span class="p">.</span><span class="n">hvn_tx_queue_size</span> <span class="o">=</span> <span class="mi">10</span>
<span class="p">};</span>
<span class="n">ret</span> <span class="o">=</span> <span class="n">sd_ble_cfg_set</span><span class="p">(</span><span class="n">BLE_CONN_CFG_GATTC</span><span class="p">,</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span><span class="n">rm_start</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></figure>


    </div>
</div>
</body>
</html>